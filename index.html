<html>
<!-- https://console.firebase.google.com/project/qr-hunt-1/database/qr-hunt-1-default-rtdb/data/~2F -->
<!-- Pre-Alpha Release v1.0.0 bugs: (to be fixed for v2.0.0)
(fixed) Camera glitch
(fixed) Input in any case
(fixed) Scanner timeouts
(Pushed for future update) IP address security
(fixed) Optimize round 4 code errors
(fixed) Incorrect times
Place proper landing codes
-->

<head>
  <title>QR Code Scanner</title>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@zxing/library@0.16.0/umd/index.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-database.js"></script>
  <style>
    body {
      background: url(https://cdn.pixabay.com/photo/2018/01/09/20/24/wood-3072434_960_720.jpg);
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center center;
    }

    #previewcontainer {
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      position: fixed;
    }

    #preview {
      background: transparent;
      border: 5px solid transparent;
      border-radius: 20px;
      z-index: 1;
    }

    #output {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      color: white;
      background-color: rgba(255, 0, 0, 0.1);
      z-index: 2;
    }
  </style>
</head>

<body>
  <div id="previewcontainer">
    <video id="preview"></video>
  </div>
  <div id="output"></div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA1sy05k4XhbHYxCqL1UKN_AuGwAmnOA2A",
      authDomain: "qr-hunt-1.firebaseapp.com",
      databaseURL: "https://qr-hunt-1-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "qr-hunt-1",
      storageBucket: "qr-hunt-1.appspot.com",
      messagingSenderId: "809676584252",
      appId: "1:809676584252:web:fc9412bb864fe79a071a39"
    };
    firebase.initializeApp(firebaseConfig);
    let scanTimer;
    const codeReader = new ZXing.BrowserQRCodeReader();
    function startScanTimer() {
      scanTimer = setTimeout(() => {
        location.reload();
      }, 300000);
    }
    function resetScanTimer() {
      clearTimeout(scanTimer);
      startScanTimer();
    }
    const password = ['pass1', 'pass2', 'pass3', 'pass4', 'pass5', 'pass6', 'pass7', 'pass8', 'pass9', 'pass10', 'pass11', 'pass12'];
    const round1 = ['1q1', '1q2', '1q3', '1q4', '1q5', '1q6'];
    const round1teams = ['pass13', 'pass14'];
    const round1teamssplice = []; // 6 + 2
    const round2 = ['2q1', '2q2', '2q3', '2q4'];
    const round2teams = []; // 4
    const round3 = ['3q1', '3q2'];
    const round3teams = []; // 2
    const round4 = ['4q1p10', '4q2p10', '4q3p10', '4q4p10', '4q5p10', '4q6p10', '4q7p10', '4q8p10', '4q9p10', '4q10p10', '4q11p10', '4q12p10', '4q13p10', '4q14p10', '4q15p10', '4q16p10', '4q17p10', '4q18p10', '4q19p10', '4q20p10', '4q21p15', '4q22p15', '4q23p15', '4q24p15', '4q25p15', '4q26p15', '4q27p15', '4q28p15', '4q29p15', '4q30p15', '4q31p20', '4q32p20', '4q33p20', '4q34p20', '4q35p20', '4q36p20', '4q37p20', '4q38p20', '4q39p20', '4q40p20', '4q41p25', '4q42p25', '4q43p25', '4q44p25', '4q45p25', '4q46p30', '4q47p30', '4q48p30', '4q49p30', '4q50p30'];
    const huntendtime = '2023-03-18T22:00:00+05:30';
    if (document.body.getBoundingClientRect().height > document.body.getBoundingClientRect().width) {
      document.getElementById('preview').style.maxHeight = '80vh';
      document.getElementById('preview').style.width = '80vw';
    } else if (document.body.getBoundingClientRect().height < document.body.getBoundingClientRect().width) {
      document.getElementById('preview').style.height = '80vh';
      document.getElementById('preview').style.maxWidth = '80vw';
    } else if (document.body.getBoundingClientRect().height = document.body.getBoundingClientRect().width) {
      document.getElementById('preview').style.height = '80vh';
      document.getElementById('preview').style.width = '80vw';
    }
    codeReader.getVideoInputDevices().then(videoInputDevices => {
      let deviceId;
      const rearCamera = videoInputDevices.filter(device => {
        deviceId = device.deviceId;
        return device.label.includes('back') || device.label.includes('rear');
      });
      if (!rearCamera) {
        deviceId = videoInputDevices[0].deviceId;
        document.getElementById('preview').style.transform = 'scaleX(-1)';
      }
      codeReader.decodeFromInputVideoDevice(deviceId, 'preview')
        .then(result => {
          if (round1.includes(result.text) == true && new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) <= new Date(huntendtime)) {
            var database = firebase.database().ref('round1db');
            const userInput = prompt("Please enter your group passkey: ");
            const resulttosave = result.text;
            const index = round1.indexOf(resulttosave);
            const allowedindex1 = index * 2;
            const allowedindex2 = (index * 2) + 1;
            if (password.includes(userInput.toLowerCase())) {
              if (userInput.toLowerCase() == password[allowedindex1] || userInput.toLowerCase() == password[allowedindex2]) {
                database.child(resulttosave).once('value').then(function (snapshot) {
                  if (snapshot.exists()) {
                    var savedpasskey = snapshot.val().passkey;
                    if (savedpasskey === userInput.toLowerCase()) {
                      document.getElementById('preview').style.display = 'none';
                      switch (index) {
                        case 0:
                          document.getElementById('output').innerHTML = 'Clue 1';
                          break;
                        case 1:
                          document.getElementById('output').innerHTML = 'Clue 2';
                          break;
                        case 2:
                          document.getElementById('output').innerHTML = 'Clue 3';
                          break;
                        case 3:
                          document.getElementById('output').innerHTML = 'Clue 4';
                          break;
                        case 4:
                          document.getElementById('output').innerHTML = 'Clue 5';
                          break;
                        case 5:
                          document.getElementById('output').innerHTML = 'Clue 6';
                          break;
                      }
                      document.getElementById('output').style.display = 'flex';
                    } else {
                      alert("You are late. \nReport to staff. Your team has been eliminated.");
                      document.getElementById('preview').style.display = 'none';
                      // js html div for ty
                    }
                  } else {
                    database.child(resulttosave).set({
                      passkey: userInput.toLowerCase(),
                      time: (new Date()).toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })
                    });
                    document.getElementById('preview').style.display = 'none';
                    switch (index) {
                      case 0:
                        document.getElementById('output').innerHTML = 'Clue 1';
                        break;
                      case 1:
                        document.getElementById('output').innerHTML = 'Clue 2';
                        break;
                      case 2:
                        document.getElementById('output').innerHTML = 'Clue 3';
                        break;
                      case 3:
                        document.getElementById('output').innerHTML = 'Clue 4';
                        break;
                      case 4:
                        document.getElementById('output').innerHTML = 'Clue 5';
                        break;
                      case 5:
                        document.getElementById('output').innerHTML = 'Clue 6';
                        break;
                    }
                    document.getElementById('output').style.display = 'flex';
                  }
                });
              } else {
                if (!window.alert("This isn\'t your QR. Put it back. \nIf you think this is a mistake, recheck passkey or contact staff.")) {
                  window.location.reload();
                }
              }
            } else {
              if (!window.alert("Incorrect passkey. \nTry again or contact the staff if any issue persists.")) {
                window.location.reload();
              }
            }
          } else if (round2.includes(result.text) == true && new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) <= new Date(huntendtime)) {
            var database = firebase.database().ref('round2db');
            firebase.database().ref('round1db').once('value').then(snapshot => {
              try {
                snapshot.forEach(childSnapshot => {
                  const round1pass = childSnapshot.child("passkey").val();
                  round1teamssplice.push(round1pass);
                });
                round1teams.splice(0, 0, ...round1teamssplice);
                console.log(round1teams);
                const userInput = prompt("Please enter your group passkey: ");
                const resulttosave = result.text;
                const index = round2.indexOf(resulttosave);
                const allowedindex1 = index * 2;
                const allowedindex2 = (index * 2) + 1;
                if (round1teams.includes(userInput.toLowerCase())) {
                  if (userInput.toLowerCase() == round1teams[allowedindex1] || userInput.toLowerCase() == round1teams[allowedindex2]) {
                    database.child(resulttosave).once('value').then(function (snapshot) {
                      if (snapshot.exists()) {
                        var savedpasskey = snapshot.val().passkey;
                        if (savedpasskey === userInput.toLowerCase()) {
                          document.getElementById('preview').style.display = 'none';
                          switch (index) {
                            case 0:
                              document.getElementById('output').innerHTML = 'Clue 1';
                              break;
                            case 1:
                              document.getElementById('output').innerHTML = 'Clue 2';
                              break;
                            case 2:
                              document.getElementById('output').innerHTML = 'Clue 3';
                              break;
                            case 3:
                              document.getElementById('output').innerHTML = 'Clue 4';
                              break;
                          }
                          document.getElementById('output').style.display = 'flex';
                        } else {
                          alert("You are late. \nReport to staff. Your team has been eliminated.");
                          document.getElementById('preview').style.display = 'none';
                          // js html div for ty
                        }
                      } else {
                        database.child(resulttosave).set({
                          passkey: userInput.toLowerCase(),
                          time: (new Date()).toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })
                        });
                        document.getElementById('preview').style.display = 'none';
                        switch (index) {
                          case 0:
                            document.getElementById('output').innerHTML = 'Clue 1';
                            break;
                          case 1:
                            document.getElementById('output').innerHTML = 'Clue 2';
                            break;
                          case 2:
                            document.getElementById('output').innerHTML = 'Clue 3';
                            break;
                          case 3:
                            document.getElementById('output').innerHTML = 'Clue 4';
                            break;
                        }
                        document.getElementById('output').style.display = 'flex';
                      }
                    });
                  } else {
                    if (!window.alert("This isn\'t your QR. Put it back. \nIf you think this is a mistake, recheck passkey or contact staff.")) {
                      window.location.reload();
                    }
                  }
                } else if (round1teams.includes(userInput.toLowerCase()) == false && password.includes(userInput.toLowerCase()) == true) {
                  if (!window.alert("Incorrect passkey. \nYour team has been eliminated.")) {
                    window.location.reload();
                  }
                } else {
                  if (!window.alert("Incorrect passkey. \nTry again or contact the staff if any issue persists.")) {
                    window.location.reload();
                  }
                }
              } catch (error) {
                console.error('Error retrieving data from Firebase: ', error);
              }
            });
          } else if (round3.includes(result.text) == true && new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) <= new Date(huntendtime)) {
            var database = firebase.database().ref('round3db');
            firebase.database().ref('round2db').once('value').then(snapshot => {
              try {
                snapshot.forEach(childSnapshot => {
                  const round2pass = childSnapshot.child("passkey").val();
                  round2teams.push(round2pass);
                });
                console.log(round2teams);
                const userInput = prompt("Please enter your group passkey: ");
                const resulttosave = result.text;
                const index = round3.indexOf(resulttosave);
                const allowedindex1 = index * 2;
                const allowedindex2 = (index * 2) + 1;
                if (round2teams.includes(userInput.toLowerCase())) {
                  if (userInput.toLowerCase() == round2teams[allowedindex1] || userInput.toLowerCase() == round2teams[allowedindex2]) {
                    database.child(resulttosave).once('value').then(function (snapshot) {
                      if (snapshot.exists()) {
                        var savedpasskey = snapshot.val().passkey;
                        if (savedpasskey === userInput.toLowerCase()) {
                          document.getElementById('preview').style.display = 'none';
                          switch (index) {
                            case 0:
                              document.getElementById('output').innerHTML = 'Clue 1';
                              break;
                            case 1:
                              document.getElementById('output').innerHTML = 'Clue 2';
                              break;
                          }
                          document.getElementById('output').style.display = 'flex';
                        } else {
                          alert("You are late. \nReport to staff. Your team has been eliminated.");
                          document.getElementById('preview').style.display = 'none';
                          // js html div for ty
                        }
                      } else {
                        database.child(resulttosave).set({
                          passkey: userInput.toLowerCase(),
                          time: (new Date()).toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })
                        });
                        document.getElementById('preview').style.display = 'none';
                        switch (index) {
                          case 0:
                            document.getElementById('output').innerHTML = 'Clue 1';
                            break;
                          case 1:
                            document.getElementById('output').innerHTML = 'Clue 2';
                            break;
                        }
                        document.getElementById('output').style.display = 'flex';
                      }
                    });
                  } else {
                    if (!window.alert("This isn\'t your QR. Put it back. \nIf you think this is a mistake, recheck passkey or contact staff.")) {
                      window.location.reload();
                    }
                  }
                } else if (round1teams.includes(userInput.toLowerCase()) == false && password.includes(userInput.toLowerCase()) == true) {
                  if (!window.alert("Incorrect passkey. \nYour team has been eliminated.")) {
                    window.location.reload();
                  }
                } else {
                  if (!window.alert("Incorrect passkey. \nTry again or contact the staff if any issue persists.")) {
                    window.location.reload();
                  }
                }
              } catch (error) {
                console.error('Error retrieving data from Firebase: ', error);
              }
            });
          } else if (round4.includes(result.text) == true && new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) <= new Date(huntendtime)) {
            var database = firebase.database().ref('round4db');
            const scannedpoints = parseInt(result.text.match(/\d+/g).join(''));
            firebase.database().ref('round3db').once('value').then(snapshot => {
              try {
                snapshot.forEach(childSnapshot => {
                  const round2pass = childSnapshot.child("passkey").val();
                  round3teams.push(round2pass);
                });
                console.log(round3teams);
                const userInput = prompt("Please enter your group passkey: ");
                const resulttosave = result.text;
                const index = round4.indexOf(resulttosave);
                if (round3teams.includes(userInput.toLowerCase())) {
                  if (userInput.toLowerCase() == round3teams[0] || userInput.toLowerCase() == round3teams[1]) {
                    database.child(resulttosave).once('value').then(function (snapshot) {
                      if (snapshot.exists()) {
                        if (!window.alert("This QR is already scanned.")) {
                          window.location.reload();
                        }
                      } else {
                        database.child(userInput.toLowerCase()).once('value').then(function (snapshot) {
                          if (snapshot.val() !== null) {
                            const oldpoints = snapshot.val().points;
                            const totalpoints = oldpoints + scannedpoints;
                            database.child(userInput.toLowerCase()).set({
                              points: totalpoints
                            });
                            database.child(resulttosave).set({
                              passkey: userInput.toLowerCase(),
                              time: (new Date()).toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })
                            });
                          } else {
                            const oldpoints = 0;
                            const totalpoints = oldpoints + scannedpoints;
                            database.child(userInput.toLowerCase()).set({
                              points: totalpoints
                            });
                            database.child(resulttosave).set({
                              passkey: userInput.toLowerCase(),
                              time: (new Date()).toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })
                            });
                          }
                          document.getElementById('preview').style.display = 'none';
                          document.getElementById('output').innerHTML = 'Your team just scanned and recieved ' + scannedpoints + ' points.';
                          document.getElementById('output').style.display = 'flex';
                        });
                      }
                    });
                  } else {
                    if (!window.alert("This isn\'t your QR. Put it back. \nIf you think this is a mistake, recheck passkey or contact staff.")) {
                      window.location.reload();
                    }
                  }
                } else if (round1teams.includes(userInput.toLowerCase()) == false && password.includes(userInput.toLowerCase()) == true) {
                  if (!window.alert("Incorrect passkey. \nYour team has been eliminated.")) {
                    window.location.reload();
                  }
                } else {
                  if (!window.alert("Incorrect passkey. \nTry again or contact the staff if any issue persists.")) {
                    window.location.reload();
                  }
                }
              } catch (error) {
                console.error('Error retrieving data from Firebase: ', error);
              }
            });
          } else if (new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })) >= new Date(huntendtime)) {
            if (!window.alert("This QR hunt has been ended.")) {
              window.location.reload();
            }
          } else {
            if (!window.alert("Detected QR is not a part of this QR hunt.")) {
              window.location.reload();
            }
          }
          resetScanTimer();
        })
        .catch(err => {
          console.error(err);
          if (err.message == "Permission denied" || err.message == "Permission dismissed") {
            if (!window.alert('Missing the permission to use camera. Can\'t proceed further.')) {
              window.location.reload();
            }
          } else {
            window.alert('This is an unanticipated error. Please report to staff. \n' + err.message + '.');
          }
          resetScanTimer();
        });
      startScanTimer();
    });
  </script>

</body>

</html>
