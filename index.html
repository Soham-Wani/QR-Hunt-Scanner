<html>
<!-- https://console.firebase.google.com/project/qr-hunt-1/database/qr-hunt-1-default-rtdb/data/~2F -->

<head>
  <title>QR Code Scanner</title>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@zxing/library@0.16.0/umd/index.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-database.js"></script>
  <style>
    body {
      background: url(https://cdn.pixabay.com/photo/2018/01/09/20/24/wood-3072434_960_720.jpg);
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center center;
    }

    #previewcontainer {
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      position: fixed;
    }

    #preview {
      background: transparent;
      border: 5px solid transparent;
      border-radius: 20px;
      z-index: 1;
    }

    #output {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      color: white;
      background-color: rgba(255, 0, 0, 0.1);
      z-index: 2;
    }
  </style>
</head>

<body>
  <div id="previewcontainer">
    <video id="preview"></video>
  </div>
  <div id="output"></div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA1sy05k4XhbHYxCqL1UKN_AuGwAmnOA2A",
      authDomain: "qr-hunt-1.firebaseapp.com",
      databaseURL: "https://qr-hunt-1-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "qr-hunt-1",
      storageBucket: "qr-hunt-1.appspot.com",
      messagingSenderId: "809676584252",
      appId: "1:809676584252:web:fc9412bb864fe79a071a39"
    };
    firebase.initializeApp(firebaseConfig);
    const codeReader = new ZXing.BrowserQRCodeReader();
    const password = ['pass1', 'pass2', 'pass3', 'pass4', 'pass5', 'pass6', 'pass7', 'pass8', 'pass9', 'pass10', 'pass11', 'pass12'];
    const round1 = ['1q1', '1q2', '1q3', '1q4', '1q5', '1q6'];
    const round1teams = []; // 6 + 2
    const round2 = ['2q1', '2q2', '2q3', '2q4'];
    const round2teams = []; // 4
    const round3 = ['3q1', '3q2'];
    const round3teams = []; // 2
    const round4 = ['4q1p10', '4q2p10', '4q3p10', '4q4p10', '4q5p10', '4q6p10', '4q7p10', '4q8p10', '4q9p10', '4q10p10', '4q11p10', '4q12p10', '4q13p10', '4q14p10', '4q15p10', '4q16p10', '4q17p10', '4q18p10', '4q19p10', '4q20p10', '4q21p15', '4q22p15', '4q23p15', '4q24p15', '4q25p15', '4q26p15', '4q27p15', '4q28p15', '4q29p15', '4q30p15', '4q31p20', '4q32p20', '4q33p20', '4q34p20', '4q35p20', '4q36p20', '4q37p20', '4q38p20', '4q39p20', '4q40p20', '4q41p25', '4q42p25', '4q43p25', '4q44p25', '4q45p25', '4q46p30', '4q47p30', '4q48p30', '4q49p30', '4q50p30'];
    if (document.body.getBoundingClientRect().height > document.body.getBoundingClientRect().width) {
      document.getElementById('preview').style.maxHeight = '80vh';
      document.getElementById('preview').style.width = '80vw';
    } else if (document.body.getBoundingClientRect().height < document.body.getBoundingClientRect().width) {
      document.getElementById('preview').style.height = '80vh';
      document.getElementById('preview').style.maxWidth = '80vw';
    } else if (document.body.getBoundingClientRect().height = document.body.getBoundingClientRect().width) {
      document.getElementById('preview').style.height = '80vh';
      document.getElementById('preview').style.width = '80vw';
    }
    codeReader.getVideoInputDevices().then(videoInputDevices => {
      let deviceId;
      const rearCamera = videoInputDevices.find(device => {
        deviceId = device.deviceId;
        return device.label.includes('back') || device.label.includes('rear');
      });
      if (!rearCamera) {
        deviceId = videoInputDevices[0].deviceId;
        document.getElementById('preview').style.transform = 'scaleX(-1)';
      }
      codeReader.decodeFromInputVideoDevice(deviceId, 'preview')
        .then(result => {
          if (round1.includes(result.text)) {
            var database = firebase.database().ref('round1db');
            const userInput = prompt("Please enter your group passkey: ");
            const resulttosave = result.text;
            const index = round1.indexOf(resulttosave);
            const allowedindex1 = index * 2;
            const allowedindex2 = (index * 2) + 1;
            if (password.includes(userInput)) {
              if (userInput == password[allowedindex1] || userInput == password[allowedindex2]) {
                database.child(resulttosave).once('value').then(function (snapshot) {
                  if (snapshot.exists()) {
                    var savedpasskey = snapshot.val().passkey;
                    if (savedpasskey === userInput) {
                      document.getElementById('preview').style.display = 'none';
                      switch (index) {
                        case 0:
                          document.getElementById('output').innerHTML = 'Clue 1';
                          break;
                        case 1:
                          document.getElementById('output').innerHTML = 'Clue 2';
                          break;
                        case 2:
                          document.getElementById('output').innerHTML = 'Clue 3';
                          break;
                        case 3:
                          document.getElementById('output').innerHTML = 'Clue 4';
                          break;
                        case 4:
                          document.getElementById('output').innerHTML = 'Clue 5';
                          break;
                        case 5:
                          document.getElementById('output').innerHTML = 'Clue 6';
                          break;
                      }
                      document.getElementById('output').style.display = 'flex';
                    } else {
                      alert("You are late. \nReport to staff. You have been eliminated.");
                      document.getElementById('preview').style.display = 'none';
                      // js html div for ty
                    }
                  } else {
                    database.child(resulttosave).set({
                      passkey: userInput,
                      time: (new Date()).toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })
                    });
                    document.getElementById('preview').style.display = 'none';
                    switch (index) {
                      case 0:
                        document.getElementById('output').innerHTML = 'Clue 1';
                        break;
                      case 1:
                        document.getElementById('output').innerHTML = 'Clue 2';
                        break;
                      case 2:
                        document.getElementById('output').innerHTML = 'Clue 3';
                        break;
                      case 3:
                        document.getElementById('output').innerHTML = 'Clue 4';
                        break;
                      case 4:
                        document.getElementById('output').innerHTML = 'Clue 5';
                        break;
                      case 5:
                        document.getElementById('output').innerHTML = 'Clue 6';
                        break;
                    }
                    document.getElementById('output').style.display = 'flex';
                  }
                });
              } else {
                if (!window.alert("This isn\'t your QR. Put it back. \nIf you think this is a mistake, recheck passkey or contact staff.")) {
                  window.location.reload();
                }
              }
            } else {
              if (!window.alert("Incorrect passkey. \nTry again or contact the staff if any issue persists.")) {
                window.location.reload();
              }
            }
          } else if (round2.includes(result.text)) {
            var database = firebase.database().ref('round2db');
            firebase.database().ref('round1db').once('value').then(snapshot => {
              snapshot.forEach(childSnapshot => {
                const round1pass = childSnapshot.child("passkey").val();
                round1teams.push(round1pass);
              });
              console.log(round1teams);
            }).catch(function (error) {
              console.error('Error retrieving data from Firebase: ', error);
            });
            const userInput = prompt("Please enter your group passkey: ");
            const resulttosave = result.text;
            const index = round2.indexOf(resulttosave);
            const allowedindex1 = index * 2;
            const allowedindex2 = (index * 2) + 1;
            if (password.includes(userInput)) {
              if (userInput == password[allowedindex1] || userInput == password[allowedindex2]) {
                database.child(resulttosave).once('value').then(function (snapshot) {
                  if (snapshot.exists()) {
                    var savedpasskey = snapshot.val().passkey;
                    if (savedpasskey === userInput) {
                      document.getElementById('preview').style.display = 'none';
                      switch (index) {
                        case 0:
                          document.getElementById('output').innerHTML = 'Clue 1';
                          break;
                        case 1:
                          document.getElementById('output').innerHTML = 'Clue 2';
                          break;
                        case 2:
                          document.getElementById('output').innerHTML = 'Clue 3';
                          break;
                        case 3:
                          document.getElementById('output').innerHTML = 'Clue 4';
                          break;
                      }
                      document.getElementById('output').style.display = 'flex';
                    } else {
                      alert("You are late. \nReport to staff. You have been eliminated.");
                      document.getElementById('preview').style.display = 'none';
                      // js html div for ty
                    }
                  } else {
                    database.child(resulttosave).set({
                      passkey: userInput,
                      time: (new Date()).toLocaleString('en-US', { timeZone: 'Asia/Kolkata' })
                    });
                    document.getElementById('preview').style.display = 'none';
                    switch (index) {
                      case 0:
                        document.getElementById('output').innerHTML = 'Clue 1';
                        break;
                      case 1:
                        document.getElementById('output').innerHTML = 'Clue 2';
                        break;
                      case 2:
                        document.getElementById('output').innerHTML = 'Clue 3';
                        break;
                      case 3:
                        document.getElementById('output').innerHTML = 'Clue 4';
                        break;
                    }
                    document.getElementById('output').style.display = 'flex';
                  }
                });
              } else {
                if (!window.alert("This isn\'t your QR. Put it back. \nIf you think this is a mistake, recheck passkey or contact staff.")) {
                  window.location.reload();
                }
              }
            } else {
              if (!window.alert("Incorrect passkey. \nTry again or contact the staff if any issue persists.")) {
                window.location.reload();
              }
            }
          } else {
            if (!window.alert("Detected QR is not a part of this QR hunt.")) {
              window.location.reload();
            }
          }
        })
        .catch(err => {
          console.error(err);
          if (err.message == "Permission denied" || err.message == "Permission dismissed") {
            if (!window.alert('Missing the permission to use camera. Can\'t proceed further.')) {
              window.location.reload();
            }
          } else {
            window.alert('This is an unanticipated error. Please report to staff. \n' + err.message + '.');
          }
        });
    });
  </script>

</body>

</html>
